name: dbt-slim-ci

on:
  pull_request:
    branches:
      - main

jobs:
  dbt-slim:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dbt
        run: |
          pip install --upgrade pip
          pip install dbt-snowflake==1.9.2

      - name: Create profiles.yml
        run: |
          mkdir -p ~/.dbt
          cat << EOF > ~/.dbt/profiles.yml
          dbt_demo:
            target: prod
            outputs:
              prod:
                type: snowflake
                account: "${{ secrets.SF_ACCOUNT }}"
                user: "${{ secrets.SF_USER }}"
                password: "${{ secrets.SF_PASSWORD }}"
                role: "${{ secrets.SF_ROLE }}"
                database: "${{ secrets.SF_DATABASE }}"
                warehouse: "${{ secrets.SF_WAREHOUSE }}"
                schema: "${{ secrets.SF_SCHEMA }}"
                threads: 1
          EOF

      - name: dbt deps
        run: dbt deps --project-dir dbt_demo

      - name: dbt build (Slim CI)
        run: |
          if [ -f dbt_state/manifest.json ]; then
            echo "üöÄ Running Slim CI"
            dbt build \
              --project-dir dbt_demo \
              --target prod \
              --state dbt_state \
              --select state:modified+
          else
            echo "‚ö†Ô∏è No state found ‚Äì running full build"
            dbt build --project-dir dbt_demo --target prod
          fi
