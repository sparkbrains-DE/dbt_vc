# name: dbt-prod-run

# on:
#   push:
#     branches:
#       - main

# jobs:
#   run-dbt-prod:
#     runs-on: ubuntu-latest

#     steps:
#       # 1Ô∏è‚É£ Checkout repository
#       - name: Checkout code
#         uses: actions/checkout@v4

#       # 2Ô∏è‚É£ Setup Python
#       - name: Setup Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: "3.10"

#       # 3Ô∏è‚É£ Install dbt Snowflake adapter
#       - name: Install dbt
#         run: |
#           pip install --upgrade pip
#           pip install dbt-snowflake

#       - name: Create profiles.yml
#         run: |
#           mkdir -p ~/.dbt
#           cat << EOF > ~/.dbt/profiles.yml
#           dbt_demo:
#             target: prod
#             outputs:
#               prod:
#                 type: snowflake
#                 account: ${{ secrets.SF_ACCOUNT }}
#                 user: ${{ secrets.SF_USER }}
#                 password: ${{ secrets.SF_PASSWORD }}
#                 role: ${{ secrets.SF_ROLE }}
#                 database: ${{ secrets.SF_DATABASE }}
#                 warehouse: ${{ secrets.SF_WAREHOUSE }}
#                 schema: ${{ secrets.SF_SCHEMA }}
#                 threads: 8
#           EOF

#       # 5Ô∏è‚É£ Validate dbt setup (IMPORTANT)
#       - name: dbt debug
#         run: dbt debug --project-dir dbt_demo

#       # 6Ô∏è‚É£ Install dbt packages
#       - name: dbt deps
#         run: dbt deps --project-dir dbt_demo

#       # 7Ô∏è‚É£ Run dbt models in PROD
#       - name: dbt run (PROD)
#         run: dbt run --project-dir dbt_demo --target prod

#       # 8Ô∏è‚É£ Run dbt tests in PROD
#       - name: dbt test (PROD)
#         run: dbt test --project-dir dbt_demo --target prod


# ================ V2 =================

# name: dbt-prod-run
# on:
#   push:
#     branches:
#       - main
# jobs:
#   run-dbt-prod:
#     runs-on: ubuntu-latest
#     steps:
#       # 1Ô∏è‚É£ Checkout repository
#       - name: Checkout code
#         uses: actions/checkout@v4
      
#       # 2Ô∏è‚É£ Setup Python
#       - name: Setup Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: "3.10"
      
#       # 3Ô∏è‚É£ Install dbt Snowflake adapter
#       - name: Install dbt
#         run: |
#           pip install --upgrade pip
#           pip install dbt-snowflake
      
#       # 4Ô∏è‚É£ Create profiles.yml
#       - name: Create profiles.yml
#         run: |
#           mkdir -p ~/.dbt
#           cat << EOF > ~/.dbt/profiles.yml
#           dbt_demo:
#             target: prod
#             outputs:
#               prod:
#                 type: snowflake
#                 account: ${{ secrets.SF_ACCOUNT }}
#                 user: ${{ secrets.SF_USER }}
#                 password: ${{ secrets.SF_PASSWORD }}
#                 role: ${{ secrets.SF_ROLE }}
#                 database: ${{ secrets.SF_DATABASE }}
#                 warehouse: ${{ secrets.SF_WAREHOUSE }}
#                 schema: ${{ secrets.SF_SCHEMA }}
#                 threads: 8
#           EOF
      
#       # 5Ô∏è‚É£ Validate dbt setup
#       - name: dbt debug
#         run: dbt debug --project-dir dbt_demo
      
#       # 6Ô∏è‚É£ Install dbt packages
#       - name: dbt deps
#         run: dbt deps --project-dir dbt_demo
      
#       # 7Ô∏è‚É£ Run dbt models in PROD
#       - name: dbt run (PROD)
#         run: dbt run --project-dir dbt_demo --target prod
      
#       # 8Ô∏è‚É£ Run dbt tests in PROD
#       - name: dbt test (PROD)
#         run: dbt test --project-dir dbt_demo --target prod
      
#       # 9Ô∏è‚É£ Generate dbt documentation
#       - name: Generate dbt docs
#         run: |
#           dbt docs generate --project-dir dbt_demo --target prod
      
#       # üîü Copy generated docs to publishable directory
#       - name: Prepare docs for publishing
#         run: |
#           mkdir -p docs_site
#           cp dbt_demo/target/index.html docs_site/
#           cp dbt_demo/target/catalog.json docs_site/
#           cp dbt_demo/target/manifest.json docs_site/
#           cp dbt_demo/target/run_results.json docs_site/ || true
      
#       # 1Ô∏è‚É£1Ô∏è‚É£ Deploy to GitHub Pages
#       - name: Deploy to GitHub Pages
#         uses: peaceiris/actions-gh-pages@v3
#         with:
#           github_token: ${{ secrets.GH_TOKEN }}
#           publish_dir: ./docs_site
#           publish_branch: gh-pages
#           keep_files: false






# =========== V3 WITH SLIM CI ========================


# name: dbt-prod-run-slimci

# on:
#   pull_request:
#     branches:
#       - main
#     types:
#       - closed

# jobs:
#   run-dbt-prod:
#     # ‚úÖ Run only when PR is merged
#     if: github.event.pull_request.merged == true
#     runs-on: ubuntu-latest

#     steps:
#       # 1Ô∏è‚É£ Checkout repository
#       - name: Checkout code
#         uses: actions/checkout@v4

#       # 2Ô∏è‚É£ Setup Python
#       - name: Setup Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: "3.10"

#       # 3Ô∏è‚É£ Install dbt Snowflake adapter
#       - name: Install dbt
#         run: |
#           pip install --upgrade pip
#           pip install dbt-snowflake

#       # 4Ô∏è‚É£ Create profiles.yml
#       - name: Create profiles.yml
#         run: |
#           mkdir -p ~/.dbt
#           cat << EOF > ~/.dbt/profiles.yml
#           dbt_demo:
#             target: prod
#             outputs:
#               prod:
#                 type: snowflake
#                 account: ${{ secrets.SF_ACCOUNT }}
#                 user: ${{ secrets.SF_USER }}
#                 password: ${{ secrets.SF_PASSWORD }}
#                 role: ${{ secrets.SF_ROLE }}
#                 database: ${{ secrets.SF_DATABASE }}
#                 warehouse: ${{ secrets.SF_WAREHOUSE }}
#                 schema: ${{ secrets.SF_SCHEMA }}
#                 threads: 8
#           EOF

#       # 5Ô∏è‚É£ dbt debug
#       - name: dbt debug
#         run: dbt debug --project-dir dbt_demo

#       # 6Ô∏è‚É£ dbt deps
#       - name: dbt deps
#         run: dbt deps --project-dir dbt_demo

#       # 7Ô∏è‚É£ Download previous dbt state (Slim CI)
#       - name: Download previous dbt state
#         uses: actions/download-artifact@v4
#         with:
#           name: dbt-state
#           path: dbt_state
#         continue-on-error: true

#       # 8Ô∏è‚É£ dbt build (Slim CI)
#       - name: dbt build (PROD - Slim CI)
#         run: |
#           if [ -f dbt_state/manifest.json ]; then
#             echo "üîÅ Running Slim CI (state:modified+)"
#             dbt build \
#               --project-dir dbt_demo \
#               --target prod \
#               --state dbt_state \
#               --select state:modified+
#           else
#             echo "‚ö†Ô∏è No previous state found ‚Äì running full dbt build"
#             dbt build --project-dir dbt_demo --target prod
#           fi

#       # 9Ô∏è‚É£ Generate dbt docs
#       - name: Generate dbt docs
#         run: dbt docs generate --project-dir dbt_demo --target prod

#       # üîü Prepare docs for GitHub Pages
#       - name: Prepare docs for publishing
#         run: |
#           mkdir -p docs_site
#           cp dbt_demo/target/index.html docs_site/
#           cp dbt_demo/target/catalog.json docs_site/
#           cp dbt_demo/target/manifest.json docs_site/
#           cp dbt_demo/target/run_results.json docs_site/ || true

#       # 1Ô∏è‚É£1Ô∏è‚É£ Save dbt state for next Slim CI run
#       - name: Save dbt state
#         uses: actions/upload-artifact@v4
#         with:
#           name: dbt-state
#           path: dbt_demo/target/manifest.json

#       # 1Ô∏è‚É£2Ô∏è‚É£ Deploy dbt docs to GitHub Pages
#       - name: Deploy to GitHub Pages
#         uses: peaceiris/actions-gh-pages@v3
#         with:
#           github_token: ${{ secrets.GH_TOKEN }}
#           publish_dir: ./docs_site
#           publish_branch: gh-pages
#           keep_files: false





name: dbt-prod-build

on:
  push:
    branches:
      - main

jobs:
  dbt-prod:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # 3Ô∏è‚É£ Install dbt Snowflake
      - name: Install dbt
        run: |
          pip install --upgrade pip
          pip install dbt-snowflake==1.9.2

      # 4Ô∏è‚É£ Create profiles.yml (Snowflake)
      - name: Create profiles.yml
        run: |
          mkdir -p ~/.dbt
          cat << EOF > ~/.dbt/profiles.yml
          dbt_demo:
            target: prod
            outputs:
              prod:
                type: snowflake
                account: "${{ secrets.SF_ACCOUNT }}"
                user: "${{ secrets.SF_USER }}"
                password: "${{ secrets.SF_PASSWORD }}"
                role: "${{ secrets.SF_ROLE }}"
                database: "${{ secrets.SF_DATABASE }}"
                warehouse: "${{ secrets.SF_WAREHOUSE }}"
                schema: "${{ secrets.SF_SCHEMA }}"
                threads: 1
          EOF

      # 5Ô∏è‚É£ Install dbt deps
      - name: dbt deps
        run: dbt deps --project-dir dbt_demo

      # 6Ô∏è‚É£ FULL PROD BUILD
      - name: dbt build (FULL)
        run: |
          dbt build \
            --project-dir dbt_demo \
            --target prod

      # 7Ô∏è‚É£ Upload manifest.json for Slim CI
      - name: Upload dbt state
        uses: actions/upload-artifact@v4
        with:
          name: dbt-state
          path: dbt_demo/target/manifest.json

