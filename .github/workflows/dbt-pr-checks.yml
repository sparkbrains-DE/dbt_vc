name: dbt-pr-checks

on:
  pull_request:
    branches:
      - main
    paths:
      - 'dbt_demo/**'

jobs:
  validate-dbt-metadata:
    runs-on: ubuntu-latest
    
    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for comparison

      # 2Ô∏è‚É£ Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # 3Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install dbt-snowflake pyyaml

      # 4Ô∏è‚É£ Create profiles.yml
      - name: Create profiles.yml
        run: |
          mkdir -p ~/.dbt
          cat << EOF > ~/.dbt/profiles.yml
          dbt_demo:
            target: dev
            outputs:
              dev:
                type: snowflake
                account: ${{ secrets.SF_ACCOUNT }}
                user: ${{ secrets.SF_USER }}
                password: ${{ secrets.SF_PASSWORD }}
                role: ${{ secrets.SF_ROLE }}
                database: ${{ secrets.SF_DATABASE }}
                warehouse: ${{ secrets.SF_WAREHOUSE }}
                schema: DEV_${{ github.actor }}
                threads: 4
          EOF

      # 5Ô∏è‚É£ Run dbt deps
      - name: dbt deps
        run: dbt deps --project-dir dbt_demo

      # 6Ô∏è‚É£ Validate metadata completeness
      - name: Validate dbt metadata
        run: |
          python .github/workflows/scripts/validate_metadata.py --project-dir dbt_demo

      # 7Ô∏è‚É£ Check for schema changes
      - name: Check schema changes
        run: |
          python .github/workflows/scripts/check_schema_changes.py --project-dir dbt_demo

      # 8Ô∏è‚É£ Run dbt compile (syntax check)
      - name: dbt compile
        run: dbt compile --project-dir dbt_demo --target dev

      # 9Ô∏è‚É£ Run SQL linting (optional)
      - name: SQL Lint with SQLFluff
        run: |
          pip install sqlfluff sqlfluff-templater-dbt
          sqlfluff lint dbt_demo/models --dialect snowflake --exclude-rules L016
        continue-on-error: true

      # üîü Run dbt in dev environment (dry run)
      - name: dbt run (dev - dry run)
        run: dbt run --project-dir dbt_demo --target dev --select state:modified+ --state dbt_demo/target
        continue-on-error: true

      # 1Ô∏è‚É£1Ô∏è‚É£ Post PR comment with validation results
      - name: Comment PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## üîç DBT PR Validation Results\n\n';
            
            try {
              const validationResults = fs.readFileSync('.github/validation_results.md', 'utf8');
              comment += validationResults;
            } catch (error) {
              comment += '‚úÖ All validation checks passed!\n';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
