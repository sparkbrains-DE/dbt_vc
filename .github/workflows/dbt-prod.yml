# name: dbt-prod-run

# on:
#   push:
#     branches:
#       - main

# jobs:
#   run-dbt-prod:
#     runs-on: ubuntu-latest

#     steps:
#       # 1Ô∏è‚É£ Checkout repository
#       - name: Checkout code
#         uses: actions/checkout@v4

#       # 2Ô∏è‚É£ Setup Python
#       - name: Setup Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: "3.10"

#       # 3Ô∏è‚É£ Install dbt Snowflake adapter
#       - name: Install dbt
#         run: |
#           pip install --upgrade pip
#           pip install dbt-snowflake

#       - name: Create profiles.yml
#         run: |
#           mkdir -p ~/.dbt
#           cat << EOF > ~/.dbt/profiles.yml
#           dbt_demo:
#             target: prod
#             outputs:
#               prod:
#                 type: snowflake
#                 account: ${{ secrets.SF_ACCOUNT }}
#                 user: ${{ secrets.SF_USER }}
#                 password: ${{ secrets.SF_PASSWORD }}
#                 role: ${{ secrets.SF_ROLE }}
#                 database: ${{ secrets.SF_DATABASE }}
#                 warehouse: ${{ secrets.SF_WAREHOUSE }}
#                 schema: ${{ secrets.SF_SCHEMA }}
#                 threads: 8
#           EOF

#       # 5Ô∏è‚É£ Validate dbt setup (IMPORTANT)
#       - name: dbt debug
#         run: dbt debug --project-dir dbt_demo

#       # 6Ô∏è‚É£ Install dbt packages
#       - name: dbt deps
#         run: dbt deps --project-dir dbt_demo

#       # 7Ô∏è‚É£ Run dbt models in PROD
#       - name: dbt run (PROD)
#         run: dbt run --project-dir dbt_demo --target prod

#       # 8Ô∏è‚É£ Run dbt tests in PROD
#       - name: dbt test (PROD)
#         run: dbt test --project-dir dbt_demo --target prod


# ================ V2 =================

# name: dbt-prod-run
# on:
#   push:
#     branches:
#       - main
# jobs:
#   run-dbt-prod:
#     runs-on: ubuntu-latest
#     steps:
#       # 1Ô∏è‚É£ Checkout repository
#       - name: Checkout code
#         uses: actions/checkout@v4
      
#       # 2Ô∏è‚É£ Setup Python
#       - name: Setup Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: "3.10"
      
#       # 3Ô∏è‚É£ Install dbt Snowflake adapter
#       - name: Install dbt
#         run: |
#           pip install --upgrade pip
#           pip install dbt-snowflake
      
#       # 4Ô∏è‚É£ Create profiles.yml
#       - name: Create profiles.yml
#         run: |
#           mkdir -p ~/.dbt
#           cat << EOF > ~/.dbt/profiles.yml
#           dbt_demo:
#             target: prod
#             outputs:
#               prod:
#                 type: snowflake
#                 account: ${{ secrets.SF_ACCOUNT }}
#                 user: ${{ secrets.SF_USER }}
#                 password: ${{ secrets.SF_PASSWORD }}
#                 role: ${{ secrets.SF_ROLE }}
#                 database: ${{ secrets.SF_DATABASE }}
#                 warehouse: ${{ secrets.SF_WAREHOUSE }}
#                 schema: ${{ secrets.SF_SCHEMA }}
#                 threads: 8
#           EOF
      
#       # 5Ô∏è‚É£ Validate dbt setup
#       - name: dbt debug
#         run: dbt debug --project-dir dbt_demo
      
#       # 6Ô∏è‚É£ Install dbt packages
#       - name: dbt deps
#         run: dbt deps --project-dir dbt_demo
      
#       # 7Ô∏è‚É£ Run dbt models in PROD
#       - name: dbt run (PROD)
#         run: dbt run --project-dir dbt_demo --target prod
      
#       # 8Ô∏è‚É£ Run dbt tests in PROD
#       - name: dbt test (PROD)
#         run: dbt test --project-dir dbt_demo --target prod
      
#       # 9Ô∏è‚É£ Generate dbt documentation
#       - name: Generate dbt docs
#         run: |
#           dbt docs generate --project-dir dbt_demo --target prod
      
#       # üîü Copy generated docs to publishable directory
#       - name: Prepare docs for publishing
#         run: |
#           mkdir -p docs_site
#           cp dbt_demo/target/index.html docs_site/
#           cp dbt_demo/target/catalog.json docs_site/
#           cp dbt_demo/target/manifest.json docs_site/
#           cp dbt_demo/target/run_results.json docs_site/ || true
      
#       # 1Ô∏è‚É£1Ô∏è‚É£ Deploy to GitHub Pages
#       - name: Deploy to GitHub Pages
#         uses: peaceiris/actions-gh-pages@v3
#         with:
#           github_token: ${{ secrets.GH_TOKEN }}
#           publish_dir: ./docs_site
#           publish_branch: gh-pages
#           keep_files: false






# =========== V3 WITH SLIM CI ========================
# name: dbt-prod

# on:
#   push:
#     branches:
#       - main
      
# permissions:
#   contents: write
  
# jobs:
#   dbt-prod:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout repo
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 0

#       - name: Setup Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: "3.10"

#       - name: Install dbt
#         run: |
#           pip install --upgrade pip
#           pip install dbt-snowflake==1.9.2

#       - name: Create profiles.yml
#         run: |
#           mkdir -p ~/.dbt
#           cat << EOF > ~/.dbt/profiles.yml
#           dbt_demo:
#             target: prod
#             outputs:
#               prod:
#                 type: snowflake
#                 account: "${{ secrets.SF_ACCOUNT }}"
#                 user: "${{ secrets.SF_USER }}"
#                 password: "${{ secrets.SF_PASSWORD }}"
#                 role: "${{ secrets.SF_ROLE }}"
#                 database: "${{ secrets.SF_DATABASE }}"
#                 warehouse: "${{ secrets.SF_WAREHOUSE }}"
#                 schema: "${{ secrets.SF_SCHEMA }}"
#                 threads: 1
#           EOF

#       - name: dbt deps
#         run: dbt deps --project-dir dbt_demo

#       - name: dbt build (FULL)
#         run: dbt build --project-dir dbt_demo --target prod

#       # ‚≠ê COPY MANIFEST INTO REPO
#       - name: Save manifest for Slim CI
#         run: |
#           mkdir -p dbt_state
#           cp dbt_demo/target/manifest.json dbt_state/manifest.json

#       # ‚≠ê COMMIT IT BACK TO MAIN
#       - name: Commit dbt_state
#         run: |
#           git config user.name "github-actions"
#           git config user.email "actions@github.com"
#           git add dbt_state/manifest.json
#           git commit -m "Update dbt Slim CI state" || echo "No changes"
#           git push



# =====================================

name: dbt-prod

on:
  push:
    branches:
      - main
      
permissions:
  contents: write
  
jobs:
  dbt-prod:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dbt & Snowflake CLI
        run: |
          pip install --upgrade pip
          pip install dbt-snowflake==1.9.2 snowflake-cli

      - name: Create Snowflake CLI config & profiles.yml
        run: |
          mkdir -p ~/.dbt ~/.snowflake
          # Snowflake CLI connection (username/password)
          cat << EOF > ~/.snowflake/config.toml
          [connections.demo_prod]
          account = "${{ secrets.SF_ACCOUNT }}"
          user = "${{ secrets.SF_USER }}"
          password = "${{ secrets.SF_PASSWORD }}"
          authenticator = "username+password"
          role = "${{ secrets.SF_ROLE }}"
          database = "temp_db"
          warehouse = "${{ secrets.SF_WAREHOUSE }}"
          EOF

          chmod 600 ~/.snowflake/config.toml

          
          # dbt profiles.yml - deploys to temp_db.public
          cat << EOF > ~/.dbt/profiles.yml
          dbt_demo:
            target: prod
            outputs:
              prod:
                type: snowflake
                account: "${{ secrets.SF_ACCOUNT }}"
                user: "${{ secrets.SF_USER }}"
                password: "${{ secrets.SF_PASSWORD }}"
                role: "${{ secrets.SF_ROLE }}"
                database: "temp_db"
                warehouse: "${{ secrets.SF_WAREHOUSE }}"
                schema: "public"
                threads: 1
          EOF

      - name: dbt deps
        run: dbt deps --project-dir dbt_demo

      - name: dbt build (FULL) - Validate & Generate Artifacts
        run: dbt build --project-dir dbt_demo --target prod

      # ‚≠ê DEPLOY TO SNOWFLAKE DBT PROJECT OBJECT (dbt_demo in temp_db.temp_schema)
      - name: Deploy dbt Project to Snowflake
        run: |
          snow dbt deploy \
            --connection demo_prod \
            --default-target prod \
            --project-dir dbt_demo \
            --force \

      # ‚≠ê SAVE MANIFEST FOR SLIM CI (optional)
      - name: Save manifest for Slim CI
        run: |
          mkdir -p dbt_state
          cp dbt_demo/target/manifest.json dbt_state/manifest.json

      # ‚≠ê COMMIT IT BACK TO MAIN
      - name: Commit dbt_state
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add dbt_state/manifest.json
          git commit -m "Update dbt Slim CI state" || echo "No changes"
          git push
